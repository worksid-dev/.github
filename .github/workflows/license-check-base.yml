name: License Compliance

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version for yarn license check"
        required: false
        type: string
        default: "24"
      php-version:
        description: "PHP version for composer license check"
        required: false
        type: string
        default: "8.3"
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  license-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: check-yarn
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for composer.lock
        id: check-composer
        run: |
          if [ -f composer.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js for yarn license check
        if: steps.check-yarn.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "${{ inputs.node-version }}"

      - name: Install yarn
        if: steps.check-yarn.outputs.exists == 'true'
        run: npm install -g yarn

      - name: Install license-checker
        if: steps.check-yarn.outputs.exists == 'true'
        run: yarn global add license-checker

      - name: Run yarn license check
        if: steps.check-yarn.outputs.exists == 'true'
        run: |
          yarn install --frozen-lockfile
          license-checker --onlyAllow 'MIT;BSD;BSD-2-Clause;BSD-3-Clause;Apache-2.0;ISC;Unlicense;WTFPL;0BSD;CC0-1.0'

      - name: Setup PHP for composer license check
        if: steps.check-composer.outputs.exists == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: "${{ inputs.php-version }}"

      - name: Install composer-license-checker
        if: steps.check-composer.outputs.exists == 'true'
        run: composer global require dominikb/composer-license-checker

      - name: Run composer license check
        if: steps.check-composer.outputs.exists == 'true'
        run: |
          composer install --no-dev
          composer-license-checker check --allow MIT,BSD-2-Clause,BSD-3-Clause,Apache-2.0,ISC,Unlicense,WTFPL,0BSD,CC0-1.0

      - name: No lock files found
        if: steps.check-yarn.outputs.exists == 'false' && steps.check-composer.outputs.exists == 'false'
        run: echo "No recognized lock files found. Skipping license compliance check."
